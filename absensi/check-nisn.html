<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek NISN - Sistem Absensi QR NISN</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="../js/navbar.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-qrcode"></i>
                <h3>QR Absensi</h3>
            </div>

            <ul class="sidebar-menu"></ul>
            <script>
                const userRole = "admin"; // ambil dari JWT decode misalnya
                renderSidebar(userRole);

            </script>

            <div class="sidebar-footer">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="userName">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <h1>Cek Status NISN Siswa</h1>
                <div class="page-actions">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-secondary" onclick="printReport()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #4facfe;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <h3 id="totalSiswa">0</h3>
                        <p>Total Siswa</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #28a745;">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="stat-details">
                        <h3 id="validNisn">0</h3>
                        <p>NISN Valid</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #ffc107;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-details">
                        <h3 id="invalidNisn">0</h3>
                        <p>NISN Tidak Valid</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #dc3545;">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="stat-details">
                        <h3 id="missingNisn">0</h3>
                        <p>Tidak Ada NISN</p>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="feature-card">
                <div class="card-header">
                    <i class="fas fa-filter"></i>
                    <h2>Filter Data</h2>
                </div>

                <div class="filter-grid">
                    <div class="form-group">
                        <label for="filterKelas">Filter Kelas:</label>
                        <select id="filterKelas" onchange="applyFilters()">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="filterStatus">Filter Status NISN:</label>
                        <select id="filterStatus" onchange="applyFilters()">
                            <option value="">Semua Status</option>
                            <option value="VALID">Valid</option>
                            <option value="TIDAK VALID">Tidak Valid</option>
                            <option value="TIDAK ADA">Tidak Ada</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="searchInput">Cari Siswa:</label>
                        <input type="text" id="searchInput" placeholder="NIS, NISN, atau Nama..."
                            onkeyup="applyFilters()">
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="feature-card">
                <div class="card-header">
                    <i class="fas fa-table"></i>
                    <h2>Data NISN Siswa</h2>
                    <span class="badge" id="dataCount">0 data</span>
                </div>

                <div class="table-container">
                    <table id="nisnTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIS</th>
                                <th>NISN</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Status NISN</th>
                                <th>Panjang</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="nisnTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center;">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <button class="page-btn" onclick="changePage('prev')" id="prevPage">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo">Halaman 1 dari 1</span>
                    <button class="page-btn" onclick="changePage('next')" id="nextPage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-grid">
                <div class="chart-card">
                    <h3>Distribusi Status NISN</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Distribusi per Kelas</h3>
                    <canvas id="kelasChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="feature-card">
                <div class="card-header">
                    <i class="fas fa-tools"></i>
                    <h2>Aksi Massal</h2>
                </div>

                <div class="bulk-actions">
                    <button class="btn btn-warning" onclick="fixInvalidNISN()">
                        <i class="fas fa-wrench"></i> Perbaiki NISN Tidak Valid
                    </button>
                    <button class="btn btn-primary" onclick="generateMissingQR()">
                        <i class="fas fa-qrcode"></i> Generate QR untuk yang Belum
                    </button>
                    <button class="btn btn-secondary" onclick="validateAllNISN()">
                        <i class="fas fa-sync"></i> Validasi Ulang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/script.js"></script>
    <script>
        let allStudents = [];
        let filteredStudents = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let statusChart, kelasChart;

        document.addEventListener('DOMContentLoaded', function () {
            loadNISNData();
            loadKelasFilter();
        });

        async function loadNISNData() {
            showLoading('Memuat data NISN...');

            try {
                const response = await makeRequest('/students/check-nisn', 'GET');
                console.log('Response :', response);
                if (response.success) {
                    allStudents = response.students || [];
                    updateSummary(response);
                    applyFilters();
                    renderCharts();
                } else {
                    showNotification(response.message, 'error');
                }
            } catch (error) {
                showNotification('Gagal memuat data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function updateSummary(response) {
            document.getElementById('totalSiswa').textContent = response.total || 0;
            document.getElementById('validNisn').textContent = response.valid_nisn || 0;
            document.getElementById('invalidNisn').textContent = response.invalid_nisn || 0;
            document.getElementById('missingNisn').textContent = response.missing_nisn || 0;
        }

        function loadKelasFilter() {
            const kelas = [...new Set(allStudents.map(s => s.kelas))];
            const select = document.getElementById('filterKelas');
            select.innerHTML = '<option value="">Semua Kelas</option>' +
                kelas.map(k => `<option value="${k}">${k}</option>`).join('');
        }

        function applyFilters() {
            const kelas = document.getElementById('filterKelas').value;
            const status = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredStudents = allStudents.filter(s => {
                // Filter kelas
                if (kelas && s.kelas !== kelas) return false;

                // Filter status
                if (status && s.status_nisn !== status) return false;

                // Filter search
                if (search) {
                    return s.nis.toLowerCase().includes(search) ||
                        (s.nisn && s.nisn.toLowerCase().includes(search)) ||
                        s.nama.toLowerCase().includes(search);
                }

                return true;
            });

            document.getElementById('dataCount').textContent = `${filteredStudents.length} data`;
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredStudents.slice(start, end);

            const tbody = document.getElementById('nisnTableBody');

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data</td></tr>';
            } else {
                tbody.innerHTML = pageData.map((s, index) => `
                    <tr>
                        <td>${start + index + 1}</td>
                        <td>${s.nis}</td>
                        <td>
                            ${s.nisn ?
                        `<span class="nisn-cell ${s.status_nisn === 'VALID' ? 'valid' : 'invalid'}">${s.nisn}</span>` :
                        '-'}
                        </td>
                        <td>${s.nama}</td>
                        <td>${s.kelas}</td>
                        <td>
                            <span class="status-badge status-${getStatusClass(s.status_nisn)}">
                                ${s.status_nisn}
                            </span>
                        </td>
                        <td>${s.panjang_nisn || '0'}</td>
                        <td>
                            <button class="action-btn" onclick="editNISN('${s.nis}')" title="Edit NISN">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="viewDetails('${s.nis}')" title="Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            updatePagination();
        }

        function getStatusClass(status) {
            if (status === 'VALID') return 'valid';
            if (status === 'TIDAK VALID') return 'invalid';
            return 'missing';
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages}`;

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < Math.ceil(filteredStudents.length / itemsPerPage)) {
                currentPage++;
            }
            renderTable();
        }

        function renderCharts() {
            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();

            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Valid', 'Tidak Valid', 'Tidak Ada'],
                    datasets: [{
                        data: [
                            allStudents.filter(s => s.status_nisn === 'VALID').length,
                            allStudents.filter(s => s.status_nisn === 'TIDAK VALID').length,
                            allStudents.filter(s => s.status_nisn === 'TIDAK ADA').length
                        ],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Kelas Chart
            const kelasCount = {};
            allStudents.forEach(s => {
                kelasCount[s.kelas] = (kelasCount[s.kelas] || 0) + 1;
            });

            const kelasCtx = document.getElementById('kelasChart').getContext('2d');
            if (kelasChart) kelasChart.destroy();

            kelasChart = new Chart(kelasCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(kelasCount),
                    datasets: [{
                        label: 'Jumlah Siswa',
                        data: Object.values(kelasCount),
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            stepSize: 1
                        }
                    }
                }
            });
        }

        async function editNISN(nis) {
            const student = allStudents.find(s => s.nis === nis);

            const { value: newNisn } = await Swal.fire({
                title: 'Edit NISN',
                html: `
                    <p>Nama: <strong>${student.nama}</strong></p>
                    <p>NIS: <strong>${nis}</strong></p>
                    <input type="text" id="nisnInput" class="swal2-input" 
                           value="${student.nisn || ''}" maxlength="10" placeholder="NISN 10 digit">
                `,
                focusConfirm: false,
                preConfirm: () => {
                    const nisn = document.getElementById('nisnInput').value.trim();
                    if (nisn && !/^\d{10}$/.test(nisn)) {
                        Swal.showValidationMessage('NISN harus 10 digit angka');
                        return false;
                    }
                    return nisn;
                }
            });

            if (newNisn !== undefined) {
                // Call API to update NISN
                showNotification('Fitur update NISN akan diimplementasikan', 'info');
            }
        }

        function viewDetails(nis) {
            const student = allStudents.find(s => s.nis === nis);

            Swal.fire({
                title: 'Detail Siswa',
                html: `
                    <div style="text-align: left;">
                        <p><strong>NIS:</strong> ${student.nis}</p>
                        <p><strong>NISN:</strong> ${student.nisn || '-'}</p>
                        <p><strong>Nama:</strong> ${student.nama}</p>
                        <p><strong>Kelas:</strong> ${student.kelas}</p>
                        <p><strong>Status NISN:</strong> 
                            <span class="status-badge status-${getStatusClass(student.status_nisn)}">
                                ${student.status_nisn}
                            </span>
                        </p>
                        <p><strong>Panjang NISN:</strong> ${student.panjang_nisn || '0'}</p>
                    </div>
                `,
                icon: 'info'
            });
        }

        function exportToExcel() {
            const headers = ['NIS', 'NISN', 'Nama', 'Kelas', 'Status NISN', 'Panjang'];
            const rows = filteredStudents.map(s => [
                s.nis,
                s.nisn || '',
                s.nama,
                s.kelas,
                s.status_nisn,
                s.panjang_nisn || '0'
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadFile(csv, `NISN_Report_${new Date().toISOString().slice(0, 10)}.csv`);

            showNotification(`${filteredStudents.length} data diekspor`, 'success');
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Laporan NISN</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #f0f0f0; }
                        .valid { color: green; }
                        .invalid { color: red; }
                    </style>
                </head>
                <body>
                    <h2>Laporan Status NISN</h2>
                    <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
                    <p>Total Data: ${filteredStudents.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>NIS</th>
                                <th>NISN</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredStudents.map(s => `
                                <tr>
                                    <td>${s.nis}</td>
                                    <td>${s.nisn || '-'}</td>
                                    <td>${s.nama}</td>
                                    <td>${s.kelas}</td>
                                    <td class="${s.status_nisn === 'VALID' ? 'valid' : 'invalid'}">
                                        ${s.status_nisn}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function fixInvalidNISN() {
            const invalid = allStudents.filter(s => s.status_nisn === 'TIDAK VALID');
            if (invalid.length === 0) {
                showNotification('Tidak ada NISN tidak valid', 'info');
                return;
            }

            Swal.fire({
                title: 'Perbaiki NISN',
                html: `
                    <p>Ditemukan ${invalid.length} NISN tidak valid</p>
                    <p>Fitur ini akan membersihkan NISN yang tidak valid menjadi kosong</p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Perbaiki',
                cancelButtonText: 'Batal'
            }).then(result => {
                if (result.isConfirmed) {
                    showNotification('Fitur perbaikan akan diimplementasikan', 'info');
                }
            });
        }

        function generateMissingQR() {
            const missing = allStudents.filter(s => s.status_nisn !== 'VALID');
            if (missing.length === 0) {
                showNotification('Semua siswa sudah memiliki NISN valid', 'success');
                return;
            }

            const nisList = missing.map(s => s.nis);
            localStorage.setItem('pending_generate', JSON.stringify(nisList));
            window.location.href = 'bulk-generate.html';
        }

        function validateAllNISN() {
            showLoading('Memvalidasi ulang...');
            setTimeout(() => {
                loadNISNData();
            }, 1000);
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>